<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>勇者冒险闯关</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 配置Tailwind自定义颜色和字体 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#8B5CF6', // 紫色作为主色调
                        secondary: '#EC4899', // 粉色作为辅助色
                        danger: '#EF4444', // 红色表示危险/伤害
                        success: '#10B981', // 绿色表示成功/治疗
                        neutral: '#1F2937', // 深色背景
                        'neutral-light': '#F3F4F6', // 浅色背景
                    },
                    fontFamily: {
                        game: ['"Press Start 2P"', 'cursive', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .text-shadow {
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            }
            .pixel-border {
                box-shadow: 0 0 0 2px #000, 
                            0 0 0 4px #fff,
                            4px 4px 0 4px #000;
            }
            .game-button {
                @apply bg-primary hover:bg-primary/80 text-white font-bold py-2 px-4 rounded transition-all duration-200 transform hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-primary/50;
            }
            .battle-button {
                @apply bg-secondary hover:bg-secondary/80 text-white font-bold py-1 px-3 rounded text-sm transition-all duration-200 transform hover:scale-105 active:scale-95;
            }
            .health-bar {
                @apply h-3 bg-gray-200 rounded-full overflow-hidden;
            }
            .health-fill {
                @apply h-full bg-success transition-all duration-500 ease-out;
            }
            .health-fill-enemy {
                @apply h-full bg-danger transition-all duration-500 ease-out;
            }
        }
    </style>
    
    <!-- 添加像素风格字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body class="bg-neutral text-white min-h-screen flex flex-col">
    <!-- 游戏标题 -->
    <header class="bg-primary/90 py-4 px-6 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-[clamp(1.2rem,3vw,1.8rem)] font-game text-shadow">勇者冒险闯关</h1>
            <div id="player-stats" class="hidden md:flex items-center gap-4">
                <div class="flex items-center">
                    <i class="fa fa-heart text-danger mr-2"></i>
                    <span id="header-hp">HP: 100/100</span>
                </div>
                <div class="flex items-center">
                    <i class="fa fa-bolt text-yellow-400 mr-2"></i>
                    <span id="header-mana">MP: 50/50</span>
                </div>
                <div class="flex items-center">
                    <i class="fa fa-diamond text-blue-400 mr-2"></i>
                    <span id="header-gold">金币: 100</span>
                </div>
            </div>
        </div>
    </header>

    <!-- 主游戏区域 -->
    <main class="flex-grow container mx-auto p-4 flex flex-col md:flex-row gap-6">
        <!-- 游戏状态和控制区 -->
        <div class="w-full md:w-1/4 flex flex-col gap-4">
            <!-- 玩家信息卡片 -->
            <div class="bg-neutral-light text-neutral rounded-xl p-4 shadow-xl">
                <h2 class="text-xl font-bold mb-3 border-b border-gray-300 pb-2">玩家状态</h2>
                <div class="mb-3">
                    <div class="flex justify-between mb-1">
                        <span>生命值 (HP)</span>
                        <span id="player-hp">100/100</span>
                    </div>
                    <div class="health-bar">
                        <div id="player-hp-bar" class="health-fill" style="width: 100%"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="flex justify-between mb-1">
                        <span>魔法值 (MP)</span>
                        <span id="player-mana">50/50</span>
                    </div>
                    <div class="health-bar">
                        <div id="player-mana-bar" class="health-fill" style="width: 100%; background-color: #3B82F6;"></div>
                    </div>
                </div>
                <div class="flex justify-between mb-2">
                    <span>攻击力</span>
                    <span id="player-attack">15</span>
                </div>
                <div class="flex justify-between mb-2">
                    <span>防御力</span>
                    <span id="player-defense">5</span>
                </div>
                <div class="flex justify-between">
                    <span>金币</span>
                    <span id="player-gold">100</span>
                </div>
            </div>

            <!-- 装备栏 -->
            <div class="bg-neutral-light text-neutral rounded-xl p-4 shadow-xl">
                <h2 class="text-xl font-bold mb-3 border-b border-gray-300 pb-2">装备</h2>
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span>武器:</span>
                        <span id="player-weapon" class="font-medium">铁剑 (攻击+5)</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>防具:</span>
                        <span id="player-armor" class="font-medium">皮甲 (防御+3)</span>
                    </div>
                </div>
                <button id="upgrade-equipment" class="game-button w-full mt-3 text-sm">
                    <i class="fa fa-refresh mr-1"></i> 升级装备 (50金币)
                </button>
            </div>

            <!-- 道具栏 -->
            <div class="bg-neutral-light text-neutral rounded-xl p-4 shadow-xl">
                <h2 class="text-xl font-bold mb-3 border-b border-gray-300 pb-2">道具</h2>
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span>治疗药水:</span>
                        <div class="flex items-center">
                            <span id="potion-count">3</span>
                            <button id="use-potion" class="battle-button ml-2">使用</button>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>魔法药水:</span>
                        <div class="flex items-center">
                            <span id="mana-potion-count">2</span>
                            <button id="use-mana-potion" class="battle-button ml-2">使用</button>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>复活卷轴:</span>
                        <div class="flex items-center">
                            <span id="revive-scroll-count">1</span>
                            <button id="use-revive-scroll" class="battle-button ml-2" disabled>使用</button>
                        </div>
                    </div>
                </div>
                <button id="buy-potion" class="game-button w-full mt-3 text-sm">
                    <i class="fa fa-shopping-cart mr-1"></i> 购买药水 (30金币)
                </button>
            </div>
        </div>

        <!-- 游戏主画面 -->
        <div class="w-full md:w-3/4 flex flex-col">
            <!-- 游戏消息区 -->
            <div id="game-messages" class="bg-neutral-light text-neutral rounded-xl p-4 mb-4 h-32 overflow-y-auto shadow-inner">
                <p>欢迎来到勇者冒险世界！请开始你的冒险吧。</p>
                <p>使用方向键或点击方向按钮移动，探索地图并击败怪物。</p>
            </div>

            <!-- 游戏地图/战斗区域 -->
            <div id="game-area" class="relative bg-neutral-light rounded-xl overflow-hidden shadow-xl flex-grow min-h-[400px]">
                <!-- 地图区域 -->
                <div id="map-area" class="w-full h-full p-4">
                    <div id="map" class="grid grid-cols-10 grid-rows-10 gap-0 w-full h-full max-w-md mx-auto">
                        <!-- 地图单元格将通过JS动态生成 -->
                    </div>
                    
                    <!-- 移动控制按钮 -->
                    <div class="flex justify-center items-center gap-2 mt-4">
                        <div class="flex flex-col items-center gap-2">
                            <button id="move-up" class="game-button">
                                <i class="fa fa-arrow-up"></i>
                            </button>
                            <div class="flex gap-2">
                                <button id="move-left" class="game-button">
                                    <i class="fa fa-arrow-left"></i>
                                </button>
                                <button id="move-down" class="game-button">
                                    <i class="fa fa-arrow-down"></i>
                                </button>
                                <button id="move-right" class="game-button">
                                    <i class="fa fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 战斗区域 (默认隐藏) -->
                <div id="battle-area" class="w-full h-full p-4 hidden">
                    <div class="text-center mb-4">
                        <h2 class="text-2xl font-bold text-neutral" id="enemy-name">与史莱姆战斗中！</h2>
                    </div>
                    
                    <div class="flex flex-col md:flex-row gap-6 items-center justify-center mb-6">
                        <!-- 玩家战斗状态 -->
                        <div class="text-center">
                            <div class="w-32 h-32 mx-auto bg-primary/20 rounded-full flex items-center justify-center mb-2">
                                <i class="fa fa-user text-5xl text-primary"></i>
                            </div>
                            <h3 class="font-bold">勇者</h3>
                            <div class="mt-2 w-40 mx-auto">
                                <div class="flex justify-between text-sm mb-1">
                                    <span>HP</span>
                                    <span id="battle-player-hp">100/100</span>
                                </div>
                                <div class="health-bar">
                                    <div id="battle-player-hp-bar" class="health-fill" style="width: 100%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 对战标志 -->
                        <div class="text-4xl text-neutral">
                            <i class="fa fa-exchange"></i>
                        </div>
                        
                        <!-- 敌人战斗状态 -->
                        <div class="text-center">
                            <div id="enemy-sprite" class="w-32 h-32 mx-auto bg-green-200 rounded-full flex items-center justify-center mb-2">
                                <i class="fa fa-question text-5xl text-green-600"></i>
                            </div>
                            <h3 class="font-bold" id="battle-enemy-name">史莱姆</h3>
                            <div class="mt-2 w-40 mx-auto">
                                <div class="flex justify-between text-sm mb-1">
                                    <span>HP</span>
                                    <span id="battle-enemy-hp">30/30</span>
                                </div>
                                <div class="health-bar">
                                    <div id="battle-enemy-hp-bar" class="health-fill-enemy" style="width: 100%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 战斗控制 -->
                    <div class="grid grid-cols-2 gap-3 max-w-md mx-auto">
                        <div class="bg-white rounded-lg p-3 shadow-md">
                            <h3 class="font-bold text-center mb-2 border-b pb-1">技能</h3>
                            <div class="grid grid-cols-2 gap-2">
                                <button id="skill-normal-attack" class="battle-button w-full">
                                    普通攻击
                                </button>
                                <button id="skill-fireball" class="battle-button w-full">
                                    火球术 (5MP)
                                </button>
                                <button id="skill-slash" class="battle-button w-full">
                                    横斩 (8MP)
                                </button>
                                <button id="skill-defend" class="battle-button w-full">
                                    防御
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg p-3 shadow-md">
                            <h3 class="font-bold text-center mb-2 border-b pb-1">道具</h3>
                            <div class="flex flex-col gap-2">
                                <button id="battle-use-potion" class="battle-button w-full">
                                    治疗药水 (+30HP)
                                </button>
                                <button id="battle-use-mana-potion" class="battle-button w-full">
                                    魔法药水 (+20MP)
                                </button>
                                <button id="attempt-escape" class="battle-button w-full bg-gray-500 hover:bg-gray-600">
                                    <i class="fa fa-sign-out mr-1"></i> 尝试逃跑
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 游戏结束界面 (默认隐藏) -->
                <div id="game-over" class="w-full h-full flex flex-col items-center justify-center bg-neutral-light text-neutral hidden">
                    <h2 class="text-3xl font-bold mb-6 text-danger">游戏结束</h2>
                    <p class="text-xl mb-8">你被怪物击败了！</p>
                    <button id="restart-game" class="game-button text-lg">
                        <i class="fa fa-refresh mr-2"></i> 重新开始
                    </button>
                </div>
                
                <!-- 胜利界面 (默认隐藏) -->
                <div id="victory-screen" class="w-full h-full flex flex-col items-center justify-center bg-neutral-light text-neutral hidden">
                    <h2 class="text-3xl font-bold mb-6 text-success">恭喜你！</h2>
                    <p class="text-xl mb-4">你成功击败了所有怪物！</p>
                    <p class="text-xl mb-8">冒险完成！</p>
                    <button id="play-again" class="game-button text-lg">
                        <i class="fa fa-play mr-2"></i> 再玩一次
                    </button>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-primary/90 py-4 px-6 mt-6">
        <div class="container mx-auto text-center">
            <p>勇者冒险闯关 &copy; 2023 | 使用方向键或屏幕按钮移动</p>
        </div>
    </footer>

    <script>
        // 游戏状态
        const gameState = {
            player: {
                x: 0,
                y: 0,
                hp: 100,
                maxHp: 100,
                mana: 50,
                maxMana: 50,
                attack: 10,
                defense: 2,
                gold: 100,
                isDefending: false,
                weapons: {
                    current: '铁剑',
                    attackBonus: 5
                },
                armor: {
                    current: '皮甲',
                    defenseBonus: 3
                }
            },
            items: {
                potions: 3,
                manaPotions: 2,
                reviveScrolls: 1
            },
            map: {
                size: 10,
                cells: [],
                playerPosition: {x: 0, y: 0},
                exitPosition: {x: 9, y: 9}
            },
            enemies: [
                {
                    name: '史莱姆',
                    hp: 30,
                    maxHp: 30,
                    attack: 8,
                    defense: 1,
                    gold: 15,
                    sprite: '<i class="fa fa-circle text-5xl text-green-600"></i>'
                },
                {
                    name: '骷髅兵',
                    hp: 50,
                    maxHp: 50,
                    attack: 12,
                    defense: 3,
                    gold: 25,
                    sprite: '<i class="fa fa-bone text-5xl text-gray-500"></i>'
                },
                {
                    name: '巫师',
                    hp: 40,
                    maxHp: 40,
                    attack: 15,
                    defense: 2,
                    gold: 35,
                    sprite: '<i class="fa fa-magic text-5xl text-purple-600"></i>'
                },
                {
                    name: '食人魔',
                    hp: 80,
                    maxHp: 80,
                    attack: 18,
                    defense: 5,
                    gold: 50,
                    sprite: '<i class="fa fa-futbol-o text-5xl text-orange-600"></i>'
                },
                {
                    name: '龙',
                    hp: 150,
                    maxHp: 150,
                    attack: 25,
                    defense: 8,
                    gold: 100,
                    sprite: '<i class="fa fa-fire text-5xl text-red-600"></i>'
                }
            ],
            currentEnemy: null,
            inBattle: false,
            gameOver: false,
            victory: false,
            enemiesDefeated: 0,
            totalEnemies: 8 // 关卡总怪物数量
        };

        // DOM元素
        const elements = {
            map: document.getElementById('map'),
            gameMessages: document.getElementById('game-messages'),
            playerHp: document.getElementById('player-hp'),
            playerHpBar: document.getElementById('player-hp-bar'),
            playerMana: document.getElementById('player-mana'),
            playerManaBar: document.getElementById('player-mana-bar'),
            playerAttack: document.getElementById('player-attack'),
            playerDefense: document.getElementById('player-defense'),
            playerGold: document.getElementById('player-gold'),
            headerHp: document.getElementById('header-hp'),
            headerMana: document.getElementById('header-mana'),
            headerGold: document.getElementById('header-gold'),
            playerWeapon: document.getElementById('player-weapon'),
            playerArmor: document.getElementById('player-armor'),
            potionCount: document.getElementById('potion-count'),
            manaPotionCount: document.getElementById('mana-potion-count'),
            reviveScrollCount: document.getElementById('revive-scroll-count'),
            mapArea: document.getElementById('map-area'),
            battleArea: document.getElementById('battle-area'),
            gameOverScreen: document.getElementById('game-over'),
            victoryScreen: document.getElementById('victory-screen'),
            enemyName: document.getElementById('enemy-name'),
            battleEnemyName: document.getElementById('battle-enemy-name'),
            enemySprite: document.getElementById('enemy-sprite'),
            battlePlayerHp: document.getElementById('battle-player-hp'),
            battlePlayerHpBar: document.getElementById('battle-player-hp-bar'),
            battleEnemyHp: document.getElementById('battle-enemy-hp'),
            battleEnemyHpBar: document.getElementById('battle-enemy-hp-bar'),
            // 按钮
            moveUp: document.getElementById('move-up'),
            moveDown: document.getElementById('move-down'),
            moveLeft: document.getElementById('move-left'),
            moveRight: document.getElementById('move-right'),
            usePotion: document.getElementById('use-potion'),
            useManaPotion: document.getElementById('use-mana-potion'),
            useReviveScroll: document.getElementById('use-revive-scroll'),
            buyPotion: document.getElementById('buy-potion'),
            upgradeEquipment: document.getElementById('upgrade-equipment'),
            skillNormalAttack: document.getElementById('skill-normal-attack'),
            skillFireball: document.getElementById('skill-fireball'),
            skillSlash: document.getElementById('skill-slash'),
            skillDefend: document.getElementById('skill-defend'),
            battleUsePotion: document.getElementById('battle-use-potion'),
            battleUseManaPotion: document.getElementById('battle-use-mana-potion'),
            attemptEscape: document.getElementById('attempt-escape'),
            restartGame: document.getElementById('restart-game'),
            playAgain: document.getElementById('play-again')
        };

        // 初始化游戏
        function initGame() {
            // 初始化地图
            initMap();
            
            // 更新玩家状态显示
            updatePlayerStats();
            
            // 添加事件监听器
            addEventListeners();
            
            // 显示初始消息
            addMessage('欢迎来到勇者冒险世界！你的目标是到达地图右下角的出口。');
            addMessage('在路上你会遇到各种怪物，击败它们获得金币和装备！');
        }

        // 初始化地图
        function initMap() {
            // 清空地图
            elements.map.innerHTML = '';
            
            // 初始化地图单元格
            gameState.map.cells = [];
            for (let y = 0; y < gameState.map.size; y++) {
                const row = [];
                for (let x = 0; x < gameState.map.size; x++) {
                    // 默认是空地
                    let cellType = 'empty';
                    
                    // 随机放置怪物 (概率20%)
                    if (Math.random() < 0.2 && !(x === 0 && y === 0) && !(x === 9 && y === 9)) {
                        cellType = 'enemy';
                    }
                    
                    // 随机放置道具 (概率10%)
                    if (Math.random() < 0.1 && cellType !== 'enemy' && !(x === 0 && y === 0) && !(x === 9 && y === 9)) {
                        cellType = 'item';
                    }
                    
                    row.push(cellType);
                    
                    // 创建地图单元格元素
                    const cell = document.createElement('div');
                    cell.id = `cell-${x}-${y}`;
                    cell.className = 'border border-gray-300 bg-gray-100 relative flex items-center justify-center aspect-square transition-all duration-200';
                    
                    // 标记出口
                    if (x === gameState.map.exitPosition.x && y === gameState.map.exitPosition.y) {
                        cell.innerHTML = '<i class="fa fa-flag text-green-600 text-xl"></i>';
                        cell.classList.add('bg-green-100');
                    }
                    
                    elements.map.appendChild(cell);
                }
                gameState.map.cells.push(row);
            }
            
            // 设置玩家初始位置
            gameState.map.playerPosition = {x: 0, y: 0};
            updatePlayerPosition();
        }

        // 更新玩家位置显示
        function updatePlayerPosition() {
            // 清除之前的玩家标记
            document.querySelectorAll('.player-marker').forEach(marker => marker.remove());
            
            // 在新位置添加玩家标记
            const {x, y} = gameState.map.playerPosition;
            const cell = document.getElementById(`cell-${x}-${y}`);
            const playerMarker = document.createElement('div');
            playerMarker.className = 'player-marker absolute inset-0 flex items-center justify-center';
            playerMarker.innerHTML = '<i class="fa fa-user text-primary text-2xl"></i>';
            cell.appendChild(playerMarker);
            
            // 检查当前单元格是否有事件
            checkCellEvent(x, y);
        }

        // 检查单元格事件 (怪物、道具等)
        function checkCellEvent(x, y) {
            const cellType = gameState.map.cells[y][x];
            
            // 检查是否到达出口
            if (x === gameState.map.exitPosition.x && y === gameState.map.exitPosition.y) {
                if (gameState.enemiesDefeated >= gameState.totalEnemies) {
                    victory();
                } else {
                    addMessage('你需要先击败所有怪物才能通过出口！');
                }
                return;
            }
            
            // 遇到怪物
            if (cellType === 'enemy') {
                // 随机选择一个敌人
                const enemyIndex = Math.floor(Math.random() * gameState.enemies.length);
                gameState.currentEnemy = {...gameState.enemies[enemyIndex]};
                
                // 进入战斗
                startBattle();
                
                // 清除这个单元格的怪物
                gameState.map.cells[y][x] = 'empty';
            }
            // 发现道具
            else if (cellType === 'item') {
                const items = [
                    {type: 'potion', name: '治疗药水', count: 1},
                    {type: 'manaPotion', name: '魔法药水', count: 1},
                    {type: 'gold', name: '金币', count: Math.floor(Math.random() * 30) + 10},
                    {type: 'reviveScroll', name: '复活卷轴', count: 1}
                ];
                
                const randomItem = items[Math.floor(Math.random() * items.length)];
                addMessage(`你发现了${randomItem.name}！`);
                
                // 获得道具
                if (randomItem.type === 'gold') {
                    gameState.player.gold += randomItem.count;
                } else {
                    gameState.items[randomItem.type] += randomItem.count;
                }
                
                // 更新显示
                updatePlayerStats();
                
                // 清除这个单元格的道具
                gameState.map.cells[y][x] = 'empty';
            }
        }

        // 开始战斗
        function startBattle() {
            gameState.inBattle = true;
            
            // 更新战斗界面
            elements.enemyName.textContent = `与${gameState.currentEnemy.name}战斗中！`;
            elements.battleEnemyName.textContent = gameState.currentEnemy.name;
            elements.enemySprite.innerHTML = gameState.currentEnemy.sprite;
            updateBattleStats();
            
            // 切换显示
            elements.mapArea.classList.add('hidden');
            elements.battleArea.classList.remove('hidden');
            
            addMessage(`一只${gameState.currentEnemy.name}出现了！`);
        }

        // 结束战斗
        function endBattle(victory) {
            gameState.inBattle = false;
            gameState.player.isDefending = false;
            
            // 切换显示
            elements.battleArea.classList.add('hidden');
            elements.mapArea.classList.remove('hidden');
            
            if (victory) {
                // 战斗胜利
                gameState.enemiesDefeated++;
                gameState.player.gold += gameState.currentEnemy.gold;
                addMessage(`你击败了${gameState.currentEnemy.name}，获得了${gameState.currentEnemy.gold}金币！`);
                updatePlayerStats();
                
                // 检查是否击败了所有敌人
                if (gameState.enemiesDefeated >= gameState.totalEnemies) {
                    addMessage('太棒了！你已经击败了所有怪物，可以前往出口了。');
                }
            } else {
                // 战斗失败
                addMessage(`你被${gameState.currentEnemy.name}击败了！`);
                
                // 检查是否有复活卷轴
                if (gameState.items.reviveScrolls > 0) {
                    gameState.items.reviveScrolls--;
                    gameState.player.hp = gameState.player.maxHp / 2; // 复活后恢复一半生命值
                    addMessage('你使用了复活卷轴，恢复了部分生命值！');
                    updatePlayerStats();
                } else {
                    // 游戏结束
                    gameOver();
                }
            }
        }

        // 玩家攻击
        function playerAttack(skill = 'normal') {
            if (!gameState.inBattle || gameState.gameOver) return;
            
            let damage = 0;
            let manaCost = 0;
            let message = '';
            
            // 计算基础攻击力 (玩家攻击 + 武器加成)
            const baseAttack = gameState.player.attack + gameState.player.weapons.attackBonus;
            
            switch (skill) {
                case 'normal':
                    // 普通攻击
                    damage = Math.max(1, baseAttack - gameState.currentEnemy.defense / 2);
                    message = `你对${gameState.currentEnemy.name}使用了普通攻击，造成了${damage}点伤害！`;
                    break;
                    
                case 'fireball':
                    // 火球术 (消耗魔法)
                    manaCost = 5;
                    if (gameState.player.mana < manaCost) {
                        addMessage('魔法值不足，无法使用火球术！');
                        return;
                    }
                    
                    gameState.player.mana -= manaCost;
                    damage = Math.max(1, Math.floor(baseAttack * 1.5) - gameState.currentEnemy.defense / 3);
                    message = `你对${gameState.currentEnemy.name}使用了火球术，造成了${damage}点伤害！`;
                    break;
                    
                case 'slash':
                    // 横斩 (消耗更多魔法，但伤害更高)
                    manaCost = 8;
                    if (gameState.player.mana < manaCost) {
                        addMessage('魔法值不足，无法使用横斩！');
                        return;
                    }
                    
                    gameState.player.mana -= manaCost;
                    damage = Math.max(1, Math.floor(baseAttack * 2) - gameState.currentEnemy.defense / 4);
                    message = `你对${gameState.currentEnemy.name}使用了横斩，造成了${damage}点伤害！`;
                    break;
                    
                case 'defend':
                    // 防御
                    gameState.player.isDefending = true;
                    message = '你采取了防御姿态，减少了受到的伤害！';
                    break;
            }
            
            // 应用伤害
            if (skill !== 'defend') {
                gameState.currentEnemy.hp -= damage;
                
                // 检查敌人是否被击败
                if (gameState.currentEnemy.hp <= 0) {
                    gameState.currentEnemy.hp = 0;
                    addMessage(message);
                    updateBattleStats();
                    
                    // 延迟结束战斗，让玩家看到最后一击
                    setTimeout(() => {
                        endBattle(true);
                    }, 1000);
                    return;
                }
            }
            
            // 显示消息并更新状态
            addMessage(message);
            updateBattleStats();
            
            // 敌人反击
            setTimeout(enemyAttack, 1000);
        }

        // 敌人攻击
        function enemyAttack() {
            if (!gameState.inBattle || gameState.gameOver) return;
            
            // 计算伤害 (敌人攻击 - 玩家防御/2)
            let damage = gameState.currentEnemy.attack - (gameState.player.defense + gameState.player.armor.defenseBonus) / 2;
            
            // 如果玩家在防御，减少伤害
            if (gameState.player.isDefending) {
                damage = Math.max(1, Math.floor(damage / 2));
                gameState.player.isDefending = false; // 重置防御状态
            } else {
                damage = Math.max(1, Math.floor(damage));
            }
            
            // 应用伤害
            gameState.player.hp -= damage;
            addMessage(`${gameState.currentEnemy.name}对你发动了攻击，造成了${damage}点伤害！`);
            
            // 检查玩家是否被击败
            if (gameState.player.hp <= 0) {
                gameState.player.hp = 0;
                updateBattleStats();
                
                // 延迟结束战斗
                setTimeout(() => {
                    endBattle(false);
                }, 1000);
                return;
            }
            
            updateBattleStats();
        }

        // 使用道具
        function useItem(itemType, inBattle = false) {
            switch (itemType) {
                case 'potion':
                    if (gameState.items.potions <= 0) {
                        addMessage('没有治疗药水了！');
                        return false;
                    }
                    
                    // 使用治疗药水
                    gameState.items.potions--;
                    gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + 30);
                    addMessage('你使用了治疗药水，恢复了30点生命值！');
                    break;
                    
                case 'manaPotion':
                    if (gameState.items.manaPotions <= 0) {
                        addMessage('没有魔法药水了！');
                        return false;
                    }
                    
                    // 使用魔法药水
                    gameState.items.manaPotions--;
                    gameState.player.mana = Math.min(gameState.player.maxMana, gameState.player.mana + 20);
                    addMessage('你使用了魔法药水，恢复了20点魔法值！');
                    break;
                    
                case 'reviveScroll':
                    if (gameState.items.reviveScrolls <= 0) {
                        addMessage('没有复活卷轴了！');
                        return false;
                    }
                    
                    // 使用复活卷轴
                    gameState.items.reviveScrolls--;
                    gameState.player.hp = Math.floor(gameState.player.maxHp / 2);
                    addMessage('你使用了复活卷轴，恢复了部分生命值！');
                    break;
            }
            
            // 更新显示
            updatePlayerStats();
            if (inBattle) {
                updateBattleStats();
                
                // 如果在战斗中，使用道具后敌人会攻击
                if (itemType !== 'reviveScroll') { // 复活卷轴只在战斗外使用
                    setTimeout(enemyAttack, 1000);
                }
            }
            
            return true;
        }

        // 尝试逃跑
        function attemptEscape() {
            if (!gameState.inBattle) return;
            
            // 50%的逃跑成功率
            const success = Math.random() < 0.5;
            
            if (success) {
                addMessage('你成功逃脱了！');
                setTimeout(() => {
                    endBattle(false); // 战斗结束但不是胜利
                }, 1000);
            } else {
                addMessage('逃跑失败！敌人趁机发动了攻击！');
                setTimeout(enemyAttack, 1000);
            }
        }

        // 购买药水
        function buyPotion() {
            const cost = 30;
            
            if (gameState.player.gold < cost) {
                addMessage('金币不足，无法购买药水！');
                return;
            }
            
            gameState.player.gold -= cost;
            gameState.items.potions += 1;
            addMessage(`你花费${cost}金币购买了1瓶治疗药水。`);
            updatePlayerStats();
        }

        // 升级装备
        function upgradeEquipment() {
            const cost = 50;
            
            if (gameState.player.gold < cost) {
                addMessage('金币不足，无法升级装备！');
                return;
            }
            
            // 随机升级武器或防具
            const upgradeWeapon = Math.random() < 0.5;
            
            if (upgradeWeapon) {
                gameState.player.weapons.attackBonus += 2;
                
                // 升级武器名称
                const weaponNames = ['铁剑', '钢剑', '银剑', '金剑', '圣剑'];
                const currentIndex = weaponNames.indexOf(gameState.player.weapons.current);
                if (currentIndex < weaponNames.length - 1) {
                    gameState.player.weapons.current = weaponNames[currentIndex + 1];
                }
                
                addMessage(`你升级了武器，${gameState.player.weapons.current}的攻击力提升了！`);
            } else {
                gameState.player.armor.defenseBonus += 2;
                
                // 升级防具名称
                const armorNames = ['皮甲', '铁甲', '银甲', '金甲', '圣甲'];
                const currentIndex = armorNames.indexOf(gameState.player.armor.current);
                if (currentIndex < armorNames.length - 1) {
                    gameState.player.armor.current = armorNames[currentIndex + 1];
                }
                
                addMessage(`你升级了防具，${gameState.player.armor.current}的防御力提升了！`);
            }
            
            gameState.player.gold -= cost;
            updatePlayerStats();
        }

        // 移动玩家
        function movePlayer(dx, dy) {
            if (gameState.inBattle || gameState.gameOver || gameState.victory) return;
            
            const newX = gameState.map.playerPosition.x + dx;
            const newY = gameState.map.playerPosition.y + dy;
            
            // 检查是否在地图范围内
            if (newX >= 0 && newX < gameState.map.size && newY >= 0 && newY < gameState.map.size) {
                gameState.map.playerPosition.x = newX;
                gameState.map.playerPosition.y = newY;
                updatePlayerPosition();
                addMessage(`你移动到了(${newX}, ${newY})`);
            } else {
                addMessage('不能走出地图范围！');
            }
        }

        // 游戏结束
        function gameOver() {
            gameState.gameOver = true;
            elements.battleArea.classList.add('hidden');
            elements.mapArea.classList.add('hidden');
            elements.gameOverScreen.classList.remove('hidden');
            addMessage('游戏结束！你被怪物击败了。');
        }

        // 游戏胜利
        function victory() {
            gameState.victory = true;
            elements.mapArea.classList.add('hidden');
            elements.victoryScreen.classList.remove('hidden');
            addMessage('恭喜你！你成功完成了冒险！');
        }

        // 重新开始游戏
        function restartGame() {
            // 重置游戏状态
            gameState.player = {
                x: 0,
                y: 0,
                hp: 100,
                maxHp: 100,
                mana: 50,
                maxMana: 50,
                attack: 10,
                defense: 2,
                gold: 100,
                isDefending: false,
                weapons: {
                    current: '铁剑',
                    attackBonus: 5
                },
                armor: {
                    current: '皮甲',
                    defenseBonus: 3
                }
            };
            
            gameState.items = {
                potions: 3,
                manaPotions: 2,
                reviveScrolls: 1
            };
            
            gameState.currentEnemy = null;
            gameState.inBattle = false;
            gameState.gameOver = false;
            gameState.victory = false;
            gameState.enemiesDefeated = 0;
            
            // 重置界面
            elements.gameOverScreen.classList.add('hidden');
            elements.victoryScreen.classList.add('hidden');
            elements.battleArea.classList.add('hidden');
            elements.mapArea.classList.remove('hidden');
            
            // 清空消息
            elements.gameMessages.innerHTML = '';
            
            // 重新初始化游戏
            initGame();
        }

        // 添加游戏消息
        function addMessage(text) {
            const messageElement = document.createElement('p');
            messageElement.textContent = text;
            elements.gameMessages.appendChild(messageElement);
            
            // 滚动到最新消息
            elements.gameMessages.scrollTop = elements.gameMessages.scrollHeight;
        }

        // 更新玩家状态显示
        function updatePlayerStats() {
            // 基本状态
            elements.playerHp.textContent = `${gameState.player.hp}/${gameState.player.maxHp}`;
            elements.playerHpBar.style.width = `${(gameState.player.hp / gameState.player.maxHp) * 100}%`;
            
            elements.playerMana.textContent = `${gameState.player.mana}/${gameState.player.maxMana}`;
            elements.playerManaBar.style.width = `${(gameState.player.mana / gameState.player.maxMana) * 100}%`;
            
            elements.playerAttack.textContent = gameState.player.attack + gameState.player.weapons.attackBonus;
            elements.playerDefense.textContent = gameState.player.defense + gameState.player.armor.defenseBonus;
            elements.playerGold.textContent = gameState.player.gold;
            
            // 头部状态
            elements.headerHp.textContent = `HP: ${gameState.player.hp}/${gameState.player.maxHp}`;
            elements.headerMana.textContent = `MP: ${gameState.player.mana}/${gameState.player.maxMana}`;
            elements.headerGold.textContent = `金币: ${gameState.player.gold}`;
            
            // 装备
            elements.playerWeapon.textContent = `${gameState.player.weapons.current} (攻击+${gameState.player.weapons.attackBonus})`;
            elements.playerArmor.textContent = `${gameState.player.armor.current} (防御+${gameState.player.armor.defenseBonus})`;
            
            // 道具
            elements.potionCount.textContent = gameState.items.potions;
            elements.manaPotionCount.textContent = gameState.items.manaPotions;
            elements.reviveScrollCount.textContent = gameState.items.reviveScrolls;
            
            // 更新复活卷轴按钮状态
            elements.useReviveScroll.disabled = gameState.player.hp > 0;
        }

        // 更新战斗状态显示
        function updateBattleStats() {
            elements.battlePlayerHp.textContent = `${gameState.player.hp}/${gameState.player.maxHp}`;
            elements.battlePlayerHpBar.style.width = `${(gameState.player.hp / gameState.player.maxHp) * 100}%`;
            
            if (gameState.currentEnemy) {
                elements.battleEnemyHp.textContent = `${gameState.currentEnemy.hp}/${gameState.currentEnemy.maxHp}`;
                elements.battleEnemyHpBar.style.width = `${(gameState.currentEnemy.hp / gameState.currentEnemy.maxHp) * 100}%`;
            }
        }

        // 添加事件监听器
        function addEventListeners() {
            // 移动控制
            elements.moveUp.addEventListener('click', () => movePlayer(0, -1));
            elements.moveDown.addEventListener('click', () => movePlayer(0, 1));
            elements.moveLeft.addEventListener('click', () => movePlayer(-1, 0));
            elements.moveRight.addEventListener('click', () => movePlayer(1, 0));
            
            // 键盘控制
            document.addEventListener('keydown', (e) => {
                switch (e.key) {
                    case 'ArrowUp':
                        movePlayer(0, -1);
                        break;
                    case 'ArrowDown':
                        movePlayer(0, 1);
                        break;
                    case 'ArrowLeft':
                        movePlayer(-1, 0);
                        break;
                    case 'ArrowRight':
                        movePlayer(1, 0);
                        break;
                }
            });
            
            // 道具使用
            elements.usePotion.addEventListener('click', () => useItem('potion'));
            elements.useManaPotion.addEventListener('click', () => useItem('manaPotion'));
            elements.useReviveScroll.addEventListener('click', () => useItem('reviveScroll'));
            
            // 购买和升级
            elements.buyPotion.addEventListener('click', buyPotion);
            elements.upgradeEquipment.addEventListener('click', upgradeEquipment);
            
            // 战斗技能
            elements.skillNormalAttack.addEventListener('click', () => playerAttack('normal'));
            elements.skillFireball.addEventListener('click', () => playerAttack('fireball'));
            elements.skillSlash.addEventListener('click', () => playerAttack('slash'));
            elements.skillDefend.addEventListener('click', () => playerAttack('defend'));
            
            // 战斗中使用道具
            elements.battleUsePotion.addEventListener('click', () => useItem('potion', true));
            elements.battleUseManaPotion.addEventListener('click', () => useItem('manaPotion', true));
            
            // 逃跑
            elements.attemptEscape.addEventListener('click', attemptEscape);
            
            // 重新开始
            elements.restartGame.addEventListener('click', restartGame);
            elements.playAgain.addEventListener('click', restartGame);
        }

        // 启动游戏
        window.addEventListener('load', initGame);
    </script>
</body>
</html>
